<html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
    <title>WebRTC demo</title>
</head>
<style>
    .container {
        background: rgb(148, 144, 144);
        margin: 50px auto;
        max-width: 80%;
        text-align: center;
        padding: 2%;
    }

    button {
        margin: 1em;
    }

    input {
        margin-top: 1em;
    }

    .footer {
        background: rgb(148, 144, 144);
        text-align: center;
        padding: 2%;
        position: absolute;
        bottom: 0;
        width: 100%;
    }
</style>

<body>

<h1>A Demo for messaging in WebRTC</h1>

<h3>
    Run two instances of this webpage along with the server to test this
    application.<br> Create an offer, and then send the message. <br>Check
    the browser console to see the output.
</h3>
<div>
    User: <div id = "name" class = "name" sec:authentication="name"></div>
</div>

<!--WebRTC related code-->
<button type="button" class="btn btn-primary" onclick='createOffer()'>Create
    Offer</button>
<input id="messageInput" type="text" class="form-control"
       placeholder="message">
<button type="button" class="btn btn-primary" onclick='sendMessage()'>SEND</button>

<center>
    <video id="video-from-camera" autoplay style="max-width: 300px;"></video>
    <!-- <canvas id="video-canvas" style="height: 480px; width: 720px;"></canvas><br /><br /> -->
</center>
<div th:replace="fragments/footer :: footer"/>


<script>
    //connecting to our signaling server
    let conn = new WebSocket('ws://192.168.1.79:8080/socket');
    let name = $("#name").html();

    conn.onopen = function() {
        console.log("Connected to the signaling server");
        initialize();
    };

    conn.onmessage = function(msg) {
        console.log("Got message", msg.data);
        var content = JSON.parse(msg.data);
        var data = content.data;
        switch (content.event) {
            // when somebody wants to call us
            case "offer":
                handleOffer(data);
                break;
            case "answer":
                handleAnswer(data);
                break;
            // when a remote peer sends an ice candidate to us
            case "candidate":
                handleCandidate(data);
                break;
            default:
                break;
        }
    };

    function send(message) {
        conn.send(JSON.stringify(message));
    }

    var peerConnection;
    var dataChannel;
    var input = document.getElementById("messageInput");

    function initialize() {
        var configuration = null;

        peerConnection = new RTCPeerConnection(configuration, {
            optional : [ {
                RtpDataChannels : true
            } ]
        });

        // Setup ice handling
        peerConnection.onicecandidate = function(event) {
            if (event.candidate) {
                send({
                    event : "candidate",
                    data : event.candidate
                });
            }
        };

        // creating data channel
        dataChannel = peerConnection.createDataChannel("dataChannel", {
            reliable : true
        });

        dataChannel.onerror = function(error) {
            console.log("Error occured on datachannel:", error);
        };

        // ........................................RECEIVING MESSAGE ....................................................
        dataChannel.onmessage = function(event) {
            insertMessageToDOM(JSON.parse(event.data), false)
        };

        dataChannel.onclose = function() {
            console.log("data channel is closed");
        };
    }

    function insertMessageToDOM(options, isFromMe) {
        console.log(options.name + ": " + options.content);
    }

    function createOffer() {
        peerConnection.createOffer(function(offer) {
            send({
                event : "offer",
                data : offer
            });
            peerConnection.setLocalDescription(offer);
        }, function(error) {
            alert("Error creating an offer");
        });
    }

    function handleOffer(offer) {
        peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

        // create and send an answer to an offer
        peerConnection.createAnswer(function(answer) {
            peerConnection.setLocalDescription(answer);
            send({
                event : "answer",
                data : answer
            });
        }, function(error) {
            alert("Error creating an answer");
        });

    };

    function handleCandidate(candidate) {
        peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
    };

    function handleAnswer(answer) {
        peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        console.log("connection established successfully!!");
    };

    function sendMessage() {
        console.log(name, ": ", input.value);

        const data = {
            name,
            content: input.value,
        };
        input.value = "";
        dataChannel.send(JSON.stringify(data));
    }
</script>
<!--WebRTC related code-->
</body>

</html>